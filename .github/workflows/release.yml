name: MELPA Build Test

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
  melpa-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout your package
        uses: actions/checkout@v4
        with:
          path: org-gtd-complete

      - name: Checkout MELPA
        uses: actions/checkout@v4
        with:
          repository: melpa/melpa
          path: melpa

      - name: Setup Emacs
        uses: jcs090218/setup-emacs@master
        with:
          version: 29.1

      - name: Install imagemagick and other build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      - name: Create recipe
        run: |
          cat > melpa/recipes/org-gtd-complete << 'EOF'
          (org-gtd-complete
           :repo "${{ github.repository }}"
           :fetcher github)
          EOF

      - name: Build package
        run: |
          cd melpa
          make recipes/org-gtd-complete

      - name: Verify package was built
        run: |
          # Check if any package files were generated
          if ls melpa/packages/org-gtd-complete-*.tar 2>/dev/null; then
            echo "Package built successfully"
            # List all built packages
            ls -la melpa/packages/org-gtd-complete-*.tar
          else
            echo "Error: No package file found"
            exit 1
          fi

      - name: Check build output
        run: |
          # Ensure the tar file is not empty
          for f in melpa/packages/org-gtd-complete-*.tar; do
            if [ -s "$f" ]; then
              echo "Package $f is non-empty"
              # Display some info about the package
              tar -tzf "$f" | head -5
            else
              echo "Error: Package $f is empty"
              exit 1
            fi
          done

      - name: Quick load test
        run: |
          # Extract the package and try to load it in Emacs
          for f in melpa/packages/org-gtd-complete-*.tar; do
            echo "Testing package: $f"
            tar -xf "$f" -C /tmp
            PACKAGE_DIR=$(basename "$f" .tar)
            emacs -Q --batch \
                  -L /tmp/"$PACKAGE_DIR" \
                  -l /tmp/"$PACKAGE_DIR"/org-gtd-complete.el \
                  --eval "(message \"Package loaded successfully\")" \
                  --eval "(condition-case err (progn (require 'org-gtd-complete) (message \"Require succeeded\")) (error (message \"Require failed: %s\" err)))"
            # Clean up
            rm -rf /tmp/"$PACKAGE_DIR"
          done
